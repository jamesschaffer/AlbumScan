## TESTING STRATEGY

### Unit Tests

**CoreData Operations:**
- Save album to CoreData (identification + artwork data)
- Update album with review data
- Fetch album by artist + title (cache check before review generation)
- Delete album from history
- Query all albums (sorted by date descending)

**API Response Parsing:**
- Parse ID Call 1 success JSON (identification + metadata)
- Parse ID Call 2 success JSON (search-based identification, conditional)
- Parse review generation success JSON
- Handle malformed JSON gracefully from OpenAI API
- Detect "searchNeeded" flag from ID Call 1
- Validate search gate criteria (3+ characters, medium/high confidence)
- Parse MusicBrainz response (release MBID lookup)
- Parse Cover Art Archive response (artwork URL extraction)

**Data Model Validation:**
- Album entity saves correctly
- Arrays (genres, bullets, tracks) serialize/deserialize
- Data blobs (artwork) save and load correctly
- Date fields save correctly

**Caching Logic:**
- Check cache before review generation API call (70-80% hit rate expected)
- Title normalization for cache lookup (strip Deluxe, Remaster, etc.)
- Cache review after generation success
- Cache artwork after download (200px thumbnail + high-res)
- Cache lookup by artist + normalized title
- No cache for identification calls (always run fresh)

---

### Integration Tests

**Complete Flow Tests:**
- Camera capture → ID Call 1 → Artwork fetch → Review generation → Save to CoreData
- Camera capture → ID Call 1 (searchNeeded) → ID Call 2 → Artwork fetch → Review generation → Save to CoreData
- Camera capture → ID Call 1 success → Review generation fail → Partial save (album + metadata + artwork, no review)
- Camera capture → ID Call 1 fail → Error banner (3-second auto-dismiss)
- Camera capture → ID Call 1 returns searchNeeded → Search gate blocks → Error banner
- Artwork fetch → MusicBrainz search → Cover Art Archive download → Display or placeholder

**Navigation Flow Tests:**
- Camera View → History button → History View → Album row tap → Album Details → X → History View
- Camera View → SCAN button → Loading screens → Album Details → X → Camera View
- History View → Camera button → Camera View
- Album Details with failed review → X → Camera View (user must rescan to retry, no inline retry button)

**Error Handling Path Tests:**
- No internet → Error banner (3-second auto-dismiss) → Camera resets to idle
- ID Call 1 timeout → Error banner → Camera ready for retry
- ID Call 2 timeout → Error banner → Camera ready for retry
- Review generation timeout → Album Details with "Review Temporarily Unavailable" message
- Artwork 404 → Gray placeholder display with "Album art unavailable" text
- MusicBrainz no results → Placeholder artwork, continue to review
- Permission denied → Permission Error Screen → "Open Settings" button

**API Integration Tests:**
- ID Call 1 with real OpenAI API (`gpt-4o`, no search) using test images
- ID Call 2 with real OpenAI API (`gpt-4o-search-preview`, with search) when Call 1 returns searchNeeded
- Search gate validation (3+ characters, medium/high confidence) blocks wasteful searches
- Artwork retrieval: MusicBrainz → Cover Art Archive (using identification metadata)
- Review generation with real OpenAI API (`gpt-4o`, no search) using identification metadata
- Cache behavior: Second scan of same album returns instant cached review
- MusicBrainz search → Parse MBID → Cover Art Archive query → Download image
- Full two-tier sequential flow with real APIs: ID Call 1 (2-4s) → [Conditional ID Call 2 (3-5s)] → Artwork (1-2s) → Confirmation hold (2.5s) → Review (3-5s or instant if cached)

**Sequential Execution Tests:**
- ID Call 1 executes during Loading Screen 1 ("Flipping through every record bin in existence...")
- If searchNeeded: ID Call 2 executes (with search gate validation) during same Loading Screen 1
- Artwork fetch begins after identification succeeds (concurrent with transition)
- Loading Screen 2 displays for exactly 2.5 seconds ("We found [Album] by [Artist]" with artwork)
- Review generation executes during Loading Screen 3 ("Writing a review that's somehow both pretentious and correct...")
- Identification fails → Error banner (not full-screen error view)
- Review generation fails → Album Details with "Review Temporarily Unavailable" message (no retry button)
- Partial success prioritized: Show what succeeded (artwork + metadata) even if review failed

---

### Manual Testing

**Critical Real-World Testing:**
- **Test at actual record stores** with real albums (most important)
- Test various lighting conditions (bright, dim, overhead lights)
- Test obscure vs popular albums
- Test worn/damaged covers
- Test angled shots (not perfectly straight)
- Test partially visible covers

**Device Testing:**
- Test on multiple iPhone models if possible (different screen sizes)
- Test on oldest supported iOS version (iOS 16.0)
- Test on latest iOS version
- Test both light and dark modes

**Edge Case Testing:**
- Back cover of album (should error)
- Multiple albums in frame (should error)
- Non-album objects (should error)
- Bootleg/unofficial releases (may error)
- Albums with multiple releases (should pick one)

**Artwork Testing:**
- Popular albums (high success rate)
- Obscure albums (expect some failures)
- Non-English titles and artist names
- Albums known to be missing from Cover Art Archive
- Artwork quality on various iPhone screen sizes
- Artwork loading on slow network

**Error Scenario Testing:**
- Airplane mode (no internet)
- Permission denied (camera access)
- Timeout scenarios (slow network)
- Server errors (mock 5xx responses)
- Rate limiting (unlikely but test if possible)

**Performance Testing:**
- Scroll history with 100+ albums (smooth scrolling with cached 200px thumbnails?)
- App launch time (< 2 seconds to Camera View ready)
- ID Call 1 response time (2-4 seconds average, 80-90% success rate)
- ID Call 2 response time (3-5 seconds when triggered, 10-20% of scans)
- Artwork fetch response time (1-2 seconds average)
- Review generation response time (3-5 seconds for new albums, instant for cached 70-80%)
- Total scan time: 5-7 seconds without search, 8-13 seconds with search
- Memory usage (no leaks, NSCache holds 20-30 images)
- CoreData queries (lazy loading for large lists)

---

### Test Data

**Known Albums for Testing (Diverse Set):**

**Acclaimed Albums (Should rate high):**
- Radiohead - OK Computer (1997)
- Kanye West - My Beautiful Dark Twisted Fantasy (2010)
- The Beatles - Abbey Road (1969)

**Mixed/Controversial Albums:**
- Kanye West - Yeezus (2013) - Divisive reception
- The Beatles - Let It Be (1970) - Mixed critical consensus

**Poorly Received Albums (Should rate low):**
- Madonna - MDNA (2012)
- Earth Wind & Fire - Electric Universe (1983)

**Obscure Albums:**
- Test with local/regional releases
- Test with non-US releases
- Test with albums missing from Cover Art Archive

**Edge Cases:**
- Bootleg releases
- Picture discs
- Colored vinyl (different artwork variants)
- Reissues with different artwork
- Box sets
- Singles vs albums

---

## Verification Summary

**Document Accuracy:** This testing strategy document has been verified and updated to reflect the actual codebase implementation as of October 29, 2025.

**Major Corrections Made:**

1. **Unit Tests - CoreData Operations:**
   - **Before:** "Phase 1 data only", "Phase 2 data"
   - **After:** "Identification + artwork data", "Review data"
   - **Reason:** Two-tier identification architecture, not multi-phase

2. **Unit Tests - API Response Parsing:**
   - **Before:** "Phase 1 success JSON", "Phase 2 success JSON"
   - **After:** "ID Call 1 success JSON", "ID Call 2 success JSON", "Review generation success JSON"
   - **Added:** Search gate validation, searchNeeded flag detection, OpenAI API error handling

3. **Unit Tests - Caching Logic:**
   - **Added:** Title normalization for cache lookup (70-80% hit rate)
   - **Added:** No cache for identification calls (always run fresh)
   - **Clarified:** Cache check happens BEFORE review generation API call

4. **Integration Tests - Complete Flow Tests:**
   - **Before:** "Phase 1 → Phase 2", "Retry Review button"
   - **After:** "ID Call 1 → Artwork fetch → Review generation", detailed conditional search flow
   - **Removed:** Retry Review button references (doesn't exist in implementation)
   - **Added:** Search gate blocking scenario
   - **Added:** Partial save scenarios

5. **Integration Tests - Navigation Flow Tests:**
   - **Enhanced:** Added specific button names (History button, SCAN button, Camera button)
   - **Removed:** "Retry Review" flow (doesn't exist)
   - **Added:** "User must rescan to retry" clarification

6. **Integration Tests - Error Handling Path Tests:**
   - **Before:** "Phase 1 timeout → Error screen", "Phase 2 timeout → Partial display with retry"
   - **After:** "ID Call 1/2 timeout → Error banner (3-second auto-dismiss)", "Review generation timeout → Album Details with error message"
   - **Removed:** Retry button references
   - **Added:** Gray placeholder behavior, MusicBrainz failure handling

7. **Integration Tests - API Integration Tests:**
   - **Complete Rewrite:** Changed from "Phase 1A/1B/2/3 with Claude API" to "ID Call 1/2, Review Generation with OpenAI API"
   - **Updated Models:**
     - ID Call 1: `gpt-4o` (no search)
     - ID Call 2: `gpt-4o-search-preview` (with search)
     - Review: `gpt-4o` (no search)
   - **Added:** Search gate validation testing
   - **Added:** Cache behavior testing (second scan instant)
   - **Updated Timing:** Complete flow breakdown with actual timings

8. **Integration Tests - Sequential Execution Tests:**
   - **Before:** "Phase 1A → 1B → 2 complete sequentially", "Loading Screen 2 displays for exactly 2 seconds"
   - **After:** "ID Call 1 executes during Loading Screen 1", "Loading Screen 2 displays for exactly 2.5 seconds"
   - **Fixed:** Error handling (error banner not full-screen error view)
   - **Removed:** All retry button references

9. **Performance Testing:**
   - **Before:** "Phase 1 response time (< 4 seconds average?)", "Phase 2 response time (< 6 seconds average?)"
   - **After:** Detailed breakdown by API call:
     - ID Call 1: 2-4 seconds (80-90% success)
     - ID Call 2: 3-5 seconds (10-20% of scans)
     - Artwork: 1-2 seconds
     - Review: 3-5 seconds or instant (70-80% cached)
     - Total: 5-7 seconds without search, 8-13 seconds with search
   - **Added:** NSCache details, CoreData lazy loading

**Test Coverage Improvements Recommended:**

1. **Search Gate Testing:**
   - Test albums with < 3 readable characters (should block ID Call 2)
   - Test albums with low text confidence (should block ID Call 2)
   - Test albums with 3+ characters AND medium/high confidence (should trigger ID Call 2)

2. **Cache Behavior Testing:**
   - Verify cache hit on second scan of same album (instant review)
   - Verify title normalization strips variants (Deluxe, Remaster, etc.)
   - Verify cache miss behavior (full review generation)

3. **Error Banner Testing:**
   - Verify 3-second auto-dismiss timing
   - Verify spring animation (response: 0.4, dampingFraction: 0.8)
   - Verify camera resets to idle after dismiss

4. **Loading Screen Timing:**
   - Verify Loading Screen 2 holds for exactly 2.5 seconds
   - Verify transitions between loading states
   - Verify album/artist names display in brand green

5. **Partial Success Testing:**
   - Verify artwork failure doesn't block review display
   - Verify review failure doesn't block album details display
   - Verify suggestion message displays (no retry button)

**Architecture Changes Verified:**
- Migrated from Claude API to OpenAI API
- Changed from "Four-Phase" to "Two-Tier Identification System"
- Removed all Retry Review button functionality
- Changed from full-screen error view to error banner
- Updated all timing estimates to match actual implementation

**Status:** Test strategy now accurately reflects the two-tier identification system with OpenAI API, proper error handling patterns, and realistic performance expectations